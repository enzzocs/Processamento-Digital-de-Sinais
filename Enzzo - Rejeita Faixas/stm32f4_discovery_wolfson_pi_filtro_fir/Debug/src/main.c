#include <stm32f4xx.h>
#include <arm_math.h>
#include <stm32f4_discovery.h>
#include <stm32f4_discovery_accelerometer.h>
#include <wolfson_pi_audio.h>
#include <diag/Trace.h>
#include <tests.h>
#include <dwt.h>
#include "filter.h"
//#include "math_helper.h"

#define NUM_TAPS   576
#define BLOCK_SIZE (WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE)/4

#undef OS_USE_SEMIHOSTING
#undef CYCLE_COUNTER

int16_t TxBuffer[WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE];
int16_t RxBuffer[WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE];

__IO BUFFER_StateTypeDef buffer_offset = BUFFER_OFFSET_NONE;

__IO uint8_t Volume = 70;

uint32_t AcceleroTicks;
int16_t AcceleroAxis[3];

/* -------------------------------------------------------------------
 * Declare State buffer of size (numTaps + blockSize - 1)
 * ------------------------------------------------------------------- */
static float32_t firStateF32[BLOCK_SIZE + NUM_TAPS - 1];
static q15_t firStateQ15[BLOCK_SIZE + NUM_TAPS - 1];

/* ----------------------------------------------------------------------
** FIR Coefficients buffer. Moving average.
** ------------------------------------------------------------------- */
const float32_t firCoeffs32[NUM_TAPS] = {1.6220646589364914e-20
		,-1.5665715692279493e-08
		,-5.890606898130852e-08
		,-1.211772084261991e-07
		,-1.9119576913813289e-07
		,-2.5653592224684655e-07
		,-3.05339440514895e-07
		,-3.28020566525535e-07
		,-3.188450145257695e-07
		,-2.772663142984167e-07
		,-2.0891287360379757e-07
		,-1.2613526758959878e-07
		,-4.804475414883175e-08
		,-2.6895677041304843e-19
		,-1.2528391259659037e-08
		,-1.1969981416745162e-07
		,-3.570030066654547e-07
		,-7.588059965889815e-07
		,-1.3555112316616437e-06
		,-2.1705412865338826e-06
		,-3.2173111246601332e-06
		,-4.496356588716852e-06
		,-5.992795109314799e-06
		,-7.674292852532717e-06
		,-9.489702285725584e-06
		,-1.1368515391521582e-05
		,-1.3221250832697809e-05
		,-1.4940858967838798e-05
		,-1.6405187801167846e-05
		,-1.7480507116265832e-05
		,-1.8026038881043638e-05
		,-1.78993914488352e-05
		,-1.6962745216586063e-05
		,-1.5089590430621438e-05
		,-1.2171775956990225e-05
		,-8.126593181629343e-06
		,-2.90359372919174e-06
		,3.5091749177169594e-06
		,1.1079834204437846e-05
		,1.9728547234972477e-05
		,2.9324882615904326e-05
		,3.9686914676603894e-05
		,5.0582254517709965e-05
		,6.173114381023074e-05
		,7.281167075691818e-05
		,8.346708738278375e-05
		,9.331512204383265e-05
		,0.00010195909380574741
		,0.00010900054949482103
		,0.00011405306326776879
		,0.00011675676602174044
		,0.00011679311129780592
		,0.00011389933870298654
		,0.00010788206807732528
		,9.862944993729988e-05
		,8.612131176382738e-05
		,7.043677636002492e-05
		,5.175888784360657e-05
		,3.037586204854894e-05
		,6.678679479095347e-06
		,-1.884514210961836e-05
		,-4.5621625376912774e-05
		,-7.300414819779156e-05
		,-0.00010029073442232436
		,-0.00012674441159537847
		,-0.00015161608472835747
		,-0.0001741692449947165
		,-0.00019370571938783087
		,-0.00020959157731650753
		,-0.0002212822476678915
		,-0.00022834586913633712
		,-0.00023048390074614965
		,-0.00022754806049799265
		,-0.0002195527386937432
		,-0.00020668214810555042
		,-0.00018929162369414948
		,-0.0001679026665418543
		,-0.00014319153515500688
		,-0.00011597141612278718
		,-8.716844797695789e-05
		,-5.779211873678167e-05
		,-2.8900800136399704e-05
		,-1.5634106236912371e-06
		,2.3181594438284244e-05
		,4.436853239718876e-05
		,6.114659544393454e-05
		,7.282015117326523e-05
		,7.888561439105858e-05
		,7.906328798031853e-05
		,7.33226562779754e-05
		,6.18997611651602e-05
		,4.5305497176668745e-05
		,2.4323923354860244e-05
		,-5.981491932190963e-18
		,-2.6383490540783376e-05
		,-5.3339698784191405e-05
		,-7.922159931282572e-05
		,-0.00010227507515004231
		,-0.00012069985829078833
		,-0.00013271662012195108
		,-0.00013663817562797564
		,-0.00013094248902479906
		,-0.00011434495880490379
		,-8.586732845108374e-05
		,-4.490052442987692e-05
		,8.741227958471278e-06
		,7.477751420703288e-05
		,0.0001524323255786772
		,0.00024042006171300434
		,0.0003369484381775207
		,0.0004397392941748491
		,0.00054606772989383
		,0.0006528193901462178
		,0.0007565650699785321
		,0.0008536511699107631
		,0.0009403038956737659
		,0.0010127445027695201
		,0.0010673123526476244
		,0.001100592096601855
		,0.0011095409556407363
		,0.0010916118369950652
		,0.0010448679346627676
		,0.0009680845125452069
		,0.0008608337698316425
		,0.0007235490399403576
		,0.000557565071899126
		,0.0003651317766430183
		,0.00014939957520963078
		,-8.562465878117922e-05
		,-0.0003351511381334523
		,-0.0005937092782964164
		,-0.0008552764895389366
		,-0.0011134307631339242
		,-0.0013615232395077406
		,-0.001592866100852551
		,-0.001800930402639767
		,-0.0019795478779815207
		,-0.0021231103423763223
		,-0.002226760115738393
		,-0.002286564879758682
		,-0.0022996706110149437
		,-0.0022644266761719166
		,-0.0021804778398743776
		,-0.002048818805675647
		,-0.0018718079651194365
		,-0.0016531382423237069
		,-0.0013977642569519867
		,-0.0011117864475438852
		,-0.0008022942555005713
		,-0.0004771719201146863
		,-0.0001448718276656061
		,0.00018583835653026608
		,0.0005061474128960499
		,0.0008074828567108319
		,0.0010817948055314316
		,0.001321832017281496
		,0.0015214005671749927
		,0.001675595821326136
		,0.0017809988750909105
		,0.001835829451005609
		,0.0018400483800271549
		,0.0017954041952944948
		,0.001705420014262159
		,0.0015753187277458643
		,0.0014118864998242577
		,0.0012232766504098912
		,0.0010187580773341038
		,0.000808414408490009
		,0.0006028019875336069
		,0.00041257652067777737
		,0.00024809968272247854
		,0.00011903813892801852
		,3.39682350372834e-05
		,-2.520969070502745e-17
		,2.243406578592157e-05
		,0.00010446462016875307
		,0.0002469405696939669
		,0.0004481957139592797
		,0.0007039569463646648
		,0.001007337342459825
		,0.0013489185303056787
		,0.0017169240253507422
		,0.0020974823331485785
		,0.0024749756629101507
		,0.0028324671452960373
		,0.003152196603801303
		,0.003416132285428603
		,0.0036065636048457947
		,0.0037067179826054
		,0.0037013833389206935
		,0.00357751680486478
		,0.0033248197833481803
		,0.002936259667260988
		,0.0024085193182144258
		,0.001742356823946769
		,0.0009428600636883705
		,1.958317730766556e-05
		,-0.0010134449041696034
		,-0.0021378462293739817
		,-0.003331156456651809
		,-0.004567222877135534
		,-0.005816732236957292
		,-0.007047858656158531
		,-0.008227017978029863
		,-0.0093197111885188
		,-0.010291436241380049
		,-0.011108644822861792
		,-0.01173971838979968
		,-0.01215593630136179
		,-0.012332408103265488
		,-0.01224894205894665
		,-0.01189082287698538
		,-0.011249473255991727
		,-0.010322976330527783
		,-0.009116439303401861
		,-0.007642182416456118
		,-0.005919741847648374
		,-0.003975680011544014
		,-0.0018432019517436507
		,0.0004384180966996652
		,0.002824590481739289
		,0.005266329468440652
		,0.007711318358470822
		,0.01010509606152756
		,0.012392336804947243
		,0.014518191393033552
		,0.01642965596715103
		,0.018076932658038364
		,0.019414745925211377
		,0.020403578779775035
		,0.021010794493142766
		,0.021211611782649114
		,0.020989904784647094
		,0.020338803297457016
		,0.019261073695826407
		,0.017769266457596907
		,0.015885622254831037
		,0.013641734882910563
		,0.011077975758475087
		,0.0082426911309036
		,0.005191189342074303
		,0.001984541259538665
		,-0.0013117777670498512
		,-0.004629371568927577
		,-0.007898495925338483
		,-0.011049681220250103
		,-0.014015364116291732
		,-0.016731486810760237
		,-0.019139022993603604
		,-0.021185391291449723
		,-0.022825719714621624
		,-0.02402392835487319
		,-0.024753602210846205
		,0.9749466254124429
		,-0.024753602210846205
		,-0.02402392835487319
		,-0.022825719714621624
		,-0.021185391291449723
		,-0.019139022993603604
		,-0.016731486810760237
		,-0.014015364116291732
		,-0.011049681220250103
		,-0.007898495925338483
		,-0.004629371568927577
		,-0.0013117777670498512
		,0.001984541259538665
		,0.0051911893420743035
		,0.0082426911309036
		,0.011077975758475087
		,0.013641734882910563
		,0.01588562225483104
		,0.017769266457596907
		,0.019261073695826407
		,0.020338803297457016
		,0.020989904784647094
		,0.021211611782649114
		,0.02101079449314277
		,0.020403578779775035
		,0.01941474592521138
		,0.018076932658038367
		,0.01642965596715103
		,0.014518191393033552
		,0.012392336804947243
		,0.01010509606152756
		,0.007711318358470822
		,0.005266329468440653
		,0.002824590481739289
		,0.0004384180966996653
		,-0.0018432019517436512
		,-0.003975680011544014
		,-0.005919741847648374
		,-0.007642182416456118
		,-0.009116439303401861
		,-0.010322976330527783
		,-0.011249473255991727
		,-0.011890822876985384
		,-0.012248942058946654
		,-0.01233240810326549
		,-0.01215593630136179
		,-0.011739718389799682
		,-0.011108644822861795
		,-0.010291436241380049
		,-0.0093197111885188
		,-0.008227017978029863
		,-0.007047858656158531
		,-0.005816732236957293
		,-0.0045672228771355345
		,-0.00333115645665181
		,-0.0021378462293739826
		,-0.0010134449041696036
		,1.958317730766556e-05
		,0.0009428600636883705
		,0.001742356823946769
		,0.0024085193182144258
		,0.002936259667260988
		,0.0033248197833481807
		,0.0035775168048647814
		,0.0037013833389206944
		,0.0037067179826054003
		,0.003606563604845795
		,0.003416132285428603
		,0.003152196603801303
		,0.0028324671452960373
		,0.0024749756629101516
		,0.00209748233314858
		,0.0017169240253507422
		,0.0013489185303056787
		,0.001007337342459825
		,0.0007039569463646648
		,0.0004481957139592797
		,0.0002469405696939669
		,0.00010446462016875307
		,2.243406578592157e-05
		,-2.520969070502745e-17
		,3.396823503728342e-05
		,0.00011903813892801859
		,0.00024809968272247865
		,0.00041257652067777753
		,0.0006028019875336072
		,0.0008084144084900093
		,0.0010187580773341044
		,0.0012232766504098914
		,0.0014118864998242586
		,0.001575318727745865
		,0.0017054200142621605
		,0.0017954041952944943
		,0.0018400483800271549
		,0.001835829451005609
		,0.0017809988750909105
		,0.001675595821326136
		,0.0015214005671749927
		,0.0013218320172814963
		,0.0010817948055314316
		,0.0008074828567108323
		,0.00050614741289605
		,0.00018583835653026608
		,-0.0001448718276656062
		,-0.00047717192011468657
		,-0.0008022942555005716
		,-0.0011117864475438859
		,-0.0013977642569519876
		,-0.0016531382423237082
		,-0.0018718079651194376
		,-0.0020488188056756486
		,-0.00218047783987438
		,-0.0022644266761719157
		,-0.0022996706110149437
		,-0.002286564879758682
		,-0.002226760115738393
		,-0.0021231103423763223
		,-0.0019795478779815207
		,-0.001800930402639768
		,-0.0015928661008525514
		,-0.0013615232395077412
		,-0.0011134307631339246
		,-0.0008552764895389368
		,-0.0005937092782964168
		,-0.00033515113813345254
		,-8.562465878117927e-05
		,0.0001493995752096309
		,0.00036513177664301854
		,0.0005575650718991265
		,0.0007235490399403583
		,0.0008608337698316434
		,0.0009680845125452066
		,0.0010448679346627672
		,0.0010916118369950652
		,0.0011095409556407363
		,0.001100592096601855
		,0.0010673123526476244
		,0.0010127445027695201
		,0.0009403038956737664
		,0.0008536511699107634
		,0.0007565650699785325
		,0.0006528193901462181
		,0.0005460677298938301
		,0.00043973929417484944
		,0.0003369484381775209
		,0.00024042006171300456
		,0.00015243232557867733
		,7.477751420703294e-05
		,8.741227958471288e-06
		,-4.490052442987698e-05
		,-8.586732845108383e-05
		,-0.00011434495880490375
		,-0.000130942489024799
		,-0.00013663817562797564
		,-0.00013271662012195108
		,-0.00012069985829078833
		,-0.00010227507515004231
		,-7.922159931282572e-05
		,-5.3339698784191425e-05
		,-2.6383490540783386e-05
		,-5.981491932190966e-18
		,2.432392335486025e-05
		,4.530549717666879e-05
		,6.189976116516025e-05
		,7.332265627797547e-05
		,7.906328798031861e-05
		,7.888561439105866e-05
		,7.282015117326538e-05
		,6.114659544393466e-05
		,4.4368532397188855e-05
		,2.3181594438284295e-05
		,-1.5634106236912371e-06
		,-2.8900800136399704e-05
		,-5.779211873678167e-05
		,-8.716844797695789e-05
		,-0.00011597141612278718
		,-0.00014319153515500688
		,-0.0001679026665418543
		,-0.00018929162369414948
		,-0.00020668214810555042
		,-0.0002195527386937432
		,-0.00022754806049799287
		,-0.00023048390074614992
		,-0.0002283458691363374
		,-0.00022128224766789173
		,-0.00020959157731650793
		,-0.00019370571938783111
		,-0.00017416924499471669
		,-0.00015161608472835788
		,-0.00012674441159537872
		,-0.00010029073442232466
		,-7.300414819779156e-05
		,-4.5621625376912774e-05
		,-1.884514210961836e-05
		,6.678679479095347e-06
		,3.037586204854894e-05
		,5.175888784360657e-05
		,7.043677636002492e-05
		,8.612131176382738e-05
		,9.862944993729988e-05
		,0.00010788206807732528
		,0.00011389933870298667
		,0.00011679311129780605
		,0.00011675676602174073
		,0.00011405306326776909
		,0.00010900054949482134
		,0.0001019590938057477
		,9.331512204383277e-05
		,8.3467087382784e-05
		,7.281167075691842e-05
		,6.173114381023074e-05
		,5.0582254517709965e-05
		,3.9686914676603894e-05
		,2.9324882615904326e-05
		,1.9728547234972477e-05
		,1.1079834204437846e-05
		,3.5091749177169594e-06
		,-2.90359372919174e-06
		,-8.126593181629343e-06
		,-1.2171775956990225e-05
		,-1.5089590430621503e-05
		,-1.696274521658607e-05
		,-1.789939144883521e-05
		,-1.8026038881043645e-05
		,-1.7480507116265933e-05
		,-1.6405187801167947e-05
		,-1.4940858967838798e-05
		,-1.3221250832697828e-05
		,-1.1368515391521689e-05
		,-9.489702285725633e-06
		,-7.674292852532717e-06
		,-5.992795109314799e-06
		,-4.496356588716852e-06
		,-3.2173111246601332e-06
		,-2.1705412865338826e-06
		,-1.3555112316616437e-06
		,-7.588059965889815e-07
		,-3.570030066654547e-07
		,-1.1969981416745162e-07
		,-1.2528391259659163e-08
		,-2.689567704130516e-19
		,-4.804475414883274e-08
		,-1.2613526758960087e-07
		,-2.0891287360380172e-07
		,-2.7726631429842693e-07
		,-3.188450145257695e-07
		,-3.280205665255551e-07
		,-3.0533944051488654e-07
		,-2.5653592224687725e-07
		,-1.911957691381687e-07
		,-1.211772084261991e-07
		,-5.890606898130852e-08
		,-1.5665715692279493e-08
		,1.6220646589364914e-20
};
const q15_t firCoeffsQ15[NUM_TAPS] = {0
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,0
		,0
		,0
		,0
		,1
		,1
		,2
		,2
		,2
		,3
		,3
		,3
		,3
		,3
		,3
		,3
		,3
		,3
		,2
		,2
		,1
		,0
		,0
		,-1
		,-2
		,-3
		,-4
		,-5
		,-5
		,-6
		,-7
		,-7
		,-8
		,-8
		,-8
		,-8
		,-8
		,-7
		,-7
		,-6
		,-5
		,-4
		,-3
		,-2
		,-1
		,-1
		,0
		,1
		,2
		,2
		,2
		,2
		,2
		,2
		,1
		,0
		,-1
		,-1
		,-2
		,-3
		,-4
		,-4
		,-5
		,-5
		,-5
		,-4
		,-3
		,-2
		,0
		,2
		,4
		,7
		,11
		,14
		,17
		,21
		,24
		,27
		,30
		,33
		,34
		,36
		,36
		,35
		,34
		,31
		,28
		,23
		,18
		,11
		,4
		,-3
		,-11
		,-20
		,-29
		,-37
		,-45
		,-53
		,-60
		,-65
		,-70
		,-73
		,-75
		,-76
		,-75
		,-72
		,-68
		,-62
		,-55
		,-46
		,-37
		,-27
		,-16
		,-5
		,6
		,16
		,26
		,35
		,43
		,49
		,54
		,58
		,60
		,60
		,58
		,55
		,51
		,46
		,40
		,33
		,26
		,19
		,13
		,8
		,3
		,1
		,-1
		,0
		,3
		,8
		,14
		,23
		,33
		,44
		,56
		,68
		,81
		,92
		,103
		,111
		,118
		,121
		,121
		,117
		,108
		,96
		,78
		,57
		,30
		,0
		,-34
		,-71
		,-110
		,-150
		,-191
		,-231
		,-270
		,-306
		,-338
		,-365
		,-385
		,-399
		,-405
		,-402
		,-390
		,-369
		,-339
		,-299
		,-251
		,-194
		,-131
		,-61
		,14
		,92
		,172
		,252
		,331
		,406
		,475
		,538
		,592
		,636
		,668
		,688
		,695
		,687
		,666
		,631
		,582
		,520
		,447
		,363
		,270
		,170
		,65
		,-43
		,-152
		,-259
		,-363
		,-460
		,-549
		,-628
		,-695
		,-748
		,-788
		,-812
		,31947
		,-812
		,-788
		,-748
		,-695
		,-628
		,-549
		,-460
		,-363
		,-259
		,-152
		,-43
		,65
		,170
		,270
		,363
		,447
		,520
		,582
		,631
		,666
		,687
		,695
		,688
		,668
		,636
		,592
		,538
		,475
		,406
		,331
		,252
		,172
		,92
		,14
		,-61
		,-131
		,-194
		,-251
		,-299
		,-339
		,-369
		,-390
		,-402
		,-405
		,-399
		,-385
		,-365
		,-338
		,-306
		,-270
		,-231
		,-191
		,-150
		,-110
		,-71
		,-34
		,0
		,30
		,57
		,78
		,96
		,108
		,117
		,121
		,121
		,118
		,111
		,103
		,92
		,81
		,68
		,56
		,44
		,33
		,23
		,14
		,8
		,3
		,0
		,-1
		,1
		,3
		,8
		,13
		,19
		,26
		,33
		,40
		,46
		,51
		,55
		,58
		,60
		,60
		,58
		,54
		,49
		,43
		,35
		,26
		,16
		,6
		,-5
		,-16
		,-27
		,-37
		,-46
		,-55
		,-62
		,-68
		,-72
		,-75
		,-76
		,-75
		,-73
		,-70
		,-65
		,-60
		,-53
		,-45
		,-37
		,-29
		,-20
		,-11
		,-3
		,4
		,11
		,18
		,23
		,28
		,31
		,34
		,35
		,36
		,36
		,34
		,33
		,30
		,27
		,24
		,21
		,17
		,14
		,11
		,7
		,4
		,2
		,0
		,-2
		,-3
		,-4
		,-5
		,-5
		,-5
		,-4
		,-4
		,-3
		,-2
		,-1
		,-1
		,0
		,1
		,2
		,2
		,2
		,2
		,2
		,2
		,1
		,0
		,-1
		,-1
		,-2
		,-3
		,-4
		,-5
		,-6
		,-7
		,-7
		,-8
		,-8
		,-8
		,-8
		,-8
		,-7
		,-7
		,-6
		,-5
		,-5
		,-4
		,-3
		,-2
		,-1
		,0
		,0
		,1
		,2
		,2
		,3
		,3
		,3
		,3
		,3
		,3
		,3
		,3
		,3
		,2
		,2
		,2
		,1
		,1
		,0
		,0
		,0
		,0
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,-1
		,0
		,};  //num taps should be even and >4 for arm_filter_q15

/* ------------------------------------------------------------------
 * Global variables for FIR LPF Example
 * ------------------------------------------------------------------- */
FilterTypeDef filterType=FIR_FLOAT32;

int main(int argc, char* argv[])
{
	UNUSED(argc);
	UNUSED(argv);

#ifdef CYCLE_COUNTER
	uint32_t cycleCount;
#endif
	uint32_t i, k;

	float32_t inputF32Buffer[BLOCK_SIZE];
	float32_t outputF32Buffer[BLOCK_SIZE];

	q15_t inputQ15Buffer[BLOCK_SIZE];
	q15_t outputQ15Buffer[BLOCK_SIZE];

#ifdef OS_USE_SEMIHOSTING
	//Semihosting example
	FILE *CoefficientsFile;
#ifdef CYCLE_COUNTER
	FILE *CycleFile;
#endif
	float Coefficients[NUM_TAPS];
#endif

	// Initialise the HAL Library; it must be the first
	// instruction to be executed in the main program.
	HAL_Init();

	DWT_Enable();

#ifdef OS_USE_SEMIHOSTING
	//Semihosting example
	CoefficientsFile = fopen("coefficients.txt", "r");
	if (!CoefficientsFile) {
		trace_printf("Error trying to open CoefficientsFile. Check the name/location.\n");
		while(1);
	}

	for(i=0; i<NUM_TAPS; i++)
		fscanf(CoefficientsFile, "%f", &Coefficients[i]);

	for(i=0; i<NUM_TAPS; i++)
		trace_printf("Coefficient %d: %e\n", i, Coefficients[i]);

	fclose(CoefficientsFile);

#ifdef CYCLE_COUNTER
	CycleFile = fopen("cyclecounter.txt", "w");
	if (!CycleFile) {
		trace_printf("Error trying to open cycle counter file\n.");
		while(1);
	}
#endif

#endif

	WOLFSON_PI_AUDIO_Init((INPUT_DEVICE_LINE_IN << 8) | OUTPUT_DEVICE_BOTH, 80, AUDIO_FREQUENCY_48K);

	WOLFSON_PI_AUDIO_SetInputMode(INPUT_DEVICE_LINE_IN);

	WOLFSON_PI_AUDIO_SetMute(AUDIO_MUTE_ON);

	WOLFSON_PI_AUDIO_Play(TxBuffer, RxBuffer, WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE);

	WOLFSON_PI_AUDIO_SetVolume(Volume);

	BSP_ACCELERO_Init();

	TEST_Init();

	arm_fir_instance_f32 S;
	float32_t  *inputF32, *outputF32;

	arm_fir_instance_q15 S15;
	q15_t *inputQ15, *outputQ15;
	arm_status status;

	/* Initialize input and output buffer pointers */
	inputF32 = &inputF32Buffer[0];
	outputF32 = &outputF32Buffer[0];

	inputQ15 = &inputQ15Buffer[0];
	outputQ15 = &outputQ15Buffer[0];

	/* Call FIR init function to initialize the instance structure. */
	arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32[0], &firStateF32[0], BLOCK_SIZE);

	status=arm_fir_init_q15(&S15, NUM_TAPS, (q15_t *)&firCoeffsQ15[0], &firStateQ15[0], BLOCK_SIZE);
	if (status==ARM_MATH_ARGUMENT_ERROR) {
		trace_printf("Problem at arm_fir_init_q15. Check if num_taps is even and greater than 4.\n");
		while(1);
	}

	trace_printf("End of filter initialization.\n filterType is %d\n", filterType);

	while (1) {
		// Add your code here.
		if(buffer_offset == BUFFER_OFFSET_HALF)
		{
			DWT_Reset();

#ifdef CYCLE_COUNTER
			cycleCount = DWT_GetValue();
#endif
			if (filterType==FIR_FLOAT32) {
				for(i=0, k=0; i<(WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE/2); i++) {
					if(i%2) {
						inputF32Buffer[k] = (float32_t)(RxBuffer[i]/32768.0);//convert to float LEFT
						k++;
					}
					else {
						TxBuffer[i] = RxBuffer[i];//   RIGHT (canal de baixo no OcenAudio)
					}
				}
				arm_fir_f32(&S, inputF32, outputF32, BLOCK_SIZE);
				for(i=0, k=0; i<(WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE/2); i++) {
					if(i%2)	{
						TxBuffer[i] = (int16_t)(outputF32Buffer[k]*32768);//back to 1.15
						k++;
					}
				}
			}

			if (filterType==FIR_Q15) {
				for(i=0, k=0; i<(WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE/2); i++) {
					if(i%2) {
						inputQ15Buffer[k] = (q15_t)(RxBuffer[i]);
						k++;
					}
					else {
						TxBuffer[i] = RxBuffer[i];//pass-through
					}
				}
				arm_fir_q15(&S15, inputQ15, outputQ15, BLOCK_SIZE);
				for(i=0, k=0; i<(WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE/2); i++) {
					if(i%2)	{
						TxBuffer[i] = (int16_t)(outputQ15Buffer[k]);//back to 1.15
						k++;
					}
				}
			}

#ifdef CYCLE_COUNTER
			fprintf(CycleFile, "\nHALF: %lu", (DWT_GetValue()- cycleCount));
#endif

			buffer_offset = BUFFER_OFFSET_NONE;
		}

		if(buffer_offset == BUFFER_OFFSET_FULL)
		{
			DWT_Reset();

#ifdef CYCLE_COUNTER
			cycleCount = DWT_GetValue();
#endif

			if (filterType==FIR_FLOAT32) {
				for(i=(WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE/2), k=0; i<WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE; i++) {
					if(i%2) {
						inputF32Buffer[k] = (float32_t)(RxBuffer[i]/32768.0);//convert to float
						k++;
					}
					else {
						TxBuffer[i] = RxBuffer[i];//pass-through(int16_t)0.3*32768;//
					}
				}

				arm_fir_f32(&S, inputF32, outputF32, BLOCK_SIZE);
				for(i=(WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE/2), k=0; i<WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE; i++) {
					if(i%2)	{
						TxBuffer[i] = (int16_t)(outputF32Buffer[k]*32768.0);//back to 1.15
						k++;
					}
				}
			}

			if (filterType==FIR_Q15) {
				for(i=(WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE/2), k=0; i<WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE; i++) {
					if(i%2) {
						inputQ15Buffer[k] = (q15_t)(RxBuffer[i]);
						k++;
					}
					else {
						TxBuffer[i] = RxBuffer[i];//pass-through
					}
				}

				arm_fir_q15(&S15, inputQ15, outputQ15, BLOCK_SIZE);
				for(i=(WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE/2), k=0; i<WOLFSON_PI_AUDIO_TXRX_BUFFER_SIZE; i++) {
					if(i%2)	{
						TxBuffer[i] = (int16_t)(outputQ15Buffer[k]);//back to 1.15
						k++;
					}
				}
			}

#ifdef CYCLE_COUNTER
			fprintf(CycleFile, "\nFULL: %lu", (DWT_GetValue()- cycleCount));
#endif

			buffer_offset = BUFFER_OFFSET_NONE;
		}
		TEST_Main();
	}

#ifdef CYCLE_COUNTER
	fclose(CycleFile);
#endif
	return 0;
}

/*--------------------------------
Callbacks implementation:
--------------------------------------------------------*/

/**
  * @brief  Manages the DMA full Transfer complete event.
  */
void WOLFSON_PI_AUDIO_TransferComplete_CallBack(void)
{
	buffer_offset = BUFFER_OFFSET_FULL;
}

/**
  * @brief  Manages the DMA Half Transfer complete event.
  */
void WOLFSON_PI_AUDIO_HalfTransfer_CallBack(void)
{
	  buffer_offset = BUFFER_OFFSET_HALF;
}

/**
  * @brief  Manages the DMA FIFO error interrupt.
  * @param  None
  * @retval None
  */
void WOLFSON_PI_AUDIO_OUT_Error_CallBack(void)
{
  /* Stop the program with an infinite loop */
  while (1);
}
